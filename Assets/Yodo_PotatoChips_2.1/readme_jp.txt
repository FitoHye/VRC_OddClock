////////////////////////////////////////////////////////////////
ヨドコロちゃんのポテトチップス
////////////////////////////////////////////////////////////////


更新履歴:
2021/01/05	リリース
2021/01/13	フレーバー追加(のり塩/チョコ/ホットチリ)
2021/05/22	UNU対応
2021/07/17	フレーバー追加(ペッパー/チーズ/めんたい)
		Udon Chips対応
2021/08/17	Unity 2019正式対応
		UdonChips連携時に大量のログが流れてしまう不具合を修正

●概要

この度はヨドコロちゃんのポテトチップスをダウンロードいただき誠にありがとうございます。
必ず利用規約を確認の上ご利用ください。

本アセットはVRChatワールド作成者向けに、食べるギミック付きのポテトチップス(以下、ポテチ)を実装するためのモデルとU#スクリプトを提供するものです。
もちろんモデルのみまたはスクリプトのみの利用も可です。
クレジット表記は必須ではありませんがあると嬉しいです。報告いただけるともっと嬉しいです。


●機能

○Yodo_PotatoChips

菓子盆に盛られたポテチの山です。
そのうち6枚が個別のPickUpになっており、掴んでから離すことで食べたようなエフェクトと効果音が流れます。
食べたポテチは2秒後にポテチの山の中のランダムな場所/向きで再出現します。

ポテチの見た目や効果音はグローバルに同期します。

ポテチの見た目は3種類、食べた時の効果音は4種類ご用意してあります。
マテリアル数はポテチとエフェクトの2つのみで描画負荷は非常に軽量です。


○Udon Chips連携

v2.0からはUdon Chipsに対応しています。
Scene内に「UdonChips」のオブジェクトが存在すると、ポテチを食べた時に設定した価格が手持ちから差し引かれるようになります。
お金が足りなくなるとポテチを食べることができなくなります。

価格は自由に設定できます。デフォルトでは1ucと0uc(無料)の2種類のPrefabをご用意しています。

Udon Chipsを導入していないワールドでは、今まで通り自由に食べることができます。

「Udon Chips」についてはこちら：
https://booth.pm/ja/items/3060394


●インストール

必ず以下の順序でインポートを行ってください。

①VRCSDK3-WORLD-2021.05.17.12.52_Public以降のWorld SDK3
②SDKバージョンに対応したU#
③本アセット

基本的には最新版SDKを使用してください。
既存ワールドに追加する場合は、①と②のバージョンが↑以上であれば再インストールする必要はありません。本アセットのみをインポートしてください。
本アセットはSDK3専用です。SDK2ワールドではご利用になれません。

UdonSharpについてはこちら：https://github.com/MerlinVR/UdonSharp/


●使い方

Yodo_PotatoChips.prefabをシーンの好きな場所に配置します。

以上です。
複数個置いてもそれぞれ独立して動作します。


Udon Chipsと連携する場合は、Scene内にAssets/UdonChips/00_UdonChips/UdonChips.prefab を1つ配置してください。
UdonChips.prefabは全体で1つあればいいので、既に導入済みの場合は改めて再配置する必要はありません。

価格は初期設定では1ucとなっています。
名前に「Free」とついているPrefabは0uc(無料)で従来通り無制限に食べられます。

自分で設定する場合は、各Prefab内の「Chips/Chips (0)～(5)」を1つずつ選択し、
「Yodo_PotatoChip」が設定されたUdon Behaviour内の「Yodo_Udon Chip Price」の数値を好きな価格に設定してください。
6つのオブジェクト全てで設定する必要がありますのでご注意ください。


以下Udonちょっとわかる人向けの解説です。

～～～～ここから～～～～
Yodo_PotatoChipsは同GameObject内のPickUpのOnDrop()を検知してワールド内の全員に「食べEvent」を発生させます。
食べEventは、Yodo_EffectObjectProviderに指定したGameObjectの子(EffectObject)から空きを検索して食べEvent発生地点に移動します。
EffectObjectはAudioSourceとParticleを持っている必要があり、食べ音とエフェクトを再生します。
しかる後に、自身のScaleを一旦0にしたのちリスポン地点へ移動させます。
こうしてエフェクトとポテチを2つのオブジェクトに分割することで、位置同期が微妙でも音源が再生中に移動してしまったりするのを防いでいます。
また、エフェクトの移動はローカルなのでPosition Syncなオブジェクトはポテチ本体だけで済みます。ネットワークも軽い！

ポテチとEffectObjectはCtrl+Dなどで単純にコピーするだけで数を増やせます。
EffectObjectの数は同時再生可能なエフェクトの数なので、ポテチを増やした場合でも全部同時に食べるとかの想定でなければそんなにたくさんは要りません。
ないとは思いますが超大皿に100枚くらい置いて数十人で一斉に貪り食うなどの改変をご検討の場合はポテチと同数くらいまで増やしてください。

皿のサイズを変えた場合はYodo_spawnRandomizeRadiousでリスポン範囲を調整できます。
XYZはそれぞれParentのPositionを中心とした半径です。1とすれば中心から-1～1の範囲に出現します。
～～～～ここまで～～～～


●既知の不具合とアップデート予定

○複数人で一斉に取り合うなどしてほぼ同時に2人以上のプレイヤーが1つのポテチをつまんだ場合、
　最初につまんだ人以外からは手を離していないのに食べが発生したように見えることがあります。
　同期スピードの限界なので勘弁してください。めちゃめちゃ取り合う予定の方はポテチの数を増やすことで発生率を軽減できます。

○ポテチを持っている時にもう一方の手で掴もうとしても食べてしまう。
　しかも保持したまま2秒経つとポテチがリスポンするが、持ったままの判定になっている。
　これは「持っているかどうかの判定」のVRC側の挙動が微妙なため。
　もう少し詳しく言うと持ち替えた時に呼ばれるOnDrop()の中でpickup.IsHeldがfalseを返す。まだ持ってるのに。バグでは？？？

　てなわけでCanny書いたのでVoteして♡
　https://vrchat.canny.io/vrchat-udon-closed-alpha-bugs/p/vrcpickupisheld-and-vrcplayerapigetpickupinhand-has-inconsistented-in-ondrop

　対症療法として、とりあえず他の人が持っているポテチを横取りできないようにしてあります。
　自分で持ち替えることは少ないので大した問題にはならないはず……。

○いい素材が手に入ったら他のお菓子も作りたいな。なんか一口で食べるのにいいお菓子ある？
　お気軽にリクエストください。できそうなら増やします。


●ライセンス及び利用規約

本アセットは全てヨドコロちゃん作によるものであり、外部ライセンスコンテンツは含まれておりません。
本アセットに含まれる全てのコンテンツについては、以下の利用規約に従います。

○利用規約

本アセットはVN3ライセンスにて提供されます。
許諾事項は同梱のライセンスファイルをご確認ください。


●連絡先
twitter: @Yodokor0

生チョコ教団 なんでもフォーム
https://docs.google.com/forms/d/e/1FAIpQLSe9964vA11qDYH0gjDfkSKVDUY7RyILjmN3tqYfXGWVJzMHvQ/viewform


●宣伝

ヨドコロちゃんはVRChatUnity勉強会のサポーターメンバーです。
Discordでは本アセットについての質問や相談も受け付けます。よかったら覗いてみてね。
https://www.vrcunity.org/
